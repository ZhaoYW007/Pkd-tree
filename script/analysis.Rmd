 
```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(xtable)
library(gsubfn)
library(fmtr)
library(stringr)
library(common)
library(proto)
library(patchwork)

library(scales)

library(ggthemes)
theme_set(theme_light())
"%!in%" <- function(x, y) !("%in%"(x, y))
# setwd("/home/zmen002/KDtree/")

# options(scipen = 999)
# options(digits = 10, nsmall = 3)
```
header[] = solver,benchType,nodes,dims,file,buildTime,queryTime,wrapSize

```{R}
# setwd("/home/zmen002/KDtree")
# kd_proto <- read.csv("script/backup_data/my_kd_proto.csv", header = TRUE)
kd <- read.csv("script/data/test.csv", header = TRUE)
# cgal <- read.csv("script/data/cgal.csv", header = TRUE)
zd<-read.csv("script/data/zdtree.csv", header=TRUE)
t <-  bind_rows(zd,kd,cgal)
# View(t)

kd1core <- read.csv("script/data/test_one_core.csv", header = TRUE)
zd1core <- read.csv("script/data/zdtree_one_core.csv", header = TRUE)
t1core <- bind_rows(kd1core,zd1core)
# View(t1core)
```

```{R}
l1 <- t %>% select(benchType, nodes, dims)
l2 <- t1core %>% select(benchType,nodes,dims)
a <- intersect(l1,l2)
b <- bind_rows(t,t1core) %>% filter(solver != 'cgal') %>% 
  filter( benchType %in% a$benchType & nodes %in% a$nodes & dims %in% a$dims) %>%
  group_by(benchType)
```

define functions 
```{R}
compute <- function(t, name){
buildByNodes <- t %>%
  group_by(solver, benchType, nodes) %>%
  summarise(avg = mean(buildTime), .groups = "drop") %>%
  filter(benchType == name) %>%
  select(solver, nodes, avg)

queryByNodes <- t %>%
  group_by(solver, benchType, nodes) %>%
  summarise(avg = mean(queryTime / nodes), .groups = "drop") %>%
  filter(benchType == name) %>%
  select(solver, nodes, avg)

return (c(buildByNodes, queryByNodes))
}
```

```{R}
list[build, query] <- compute(t,"ss_varden")
View(build)
```

plot the graph
```{R}
gBuildNode <- ggplot(buildByNodes, aes(x = nodes, y = avg, color = solver, shape = solver)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave build time")+
  ggtitle("vary node")

gQueryNode <- ggplot(queryByNodes, aes(x = nodes, y = avg, color = solver, shape = solver)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave query time")
```

summarize the plot info: https://ggplot2-book.org/arranging-plots.html
c(a,b,c) combine [a,b,c]
seq(2,6,by=2) [2,4,6]

```{R}
saveid <- paste0("script/plot/", substr(system("git rev-parse HEAD", intern = TRUE), 0, 7), ".jpg")
saveid

gBuildNode + gQueryNode
ggsave(saveid, width = 12, dpi = 1800)
```

Now collect the leave wrapping
```{R}
wrap <- read.csv("script/data/single_wrap.csv", header = TRUE)
wrap

wrapQuery <- wrap %>%
  group_by(wrapSize) %>%
  summarise(avg = mean(queryTime / nodes), .groups = "drop") %>%
  select(wrapSize, avg)

wrapBuild <- wrap %>%
  group_by(wrapSize) %>%
  summarise(avg = mean(buildTime / nodes), .groups = "drop") %>%
  select(wrapSize, avg)

# gBuildWrap<-ggplot(wrapBuild, aes(x = wrapSize, y = avg))+
#   geom_point(size=3) +
#   geom_line() +
#   theme_gray() +
#   labs(y="Ave build time")

gQueryWrap <- ggplot(wrapQuery, aes(x = wrapSize, y = avg)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave query time") +
  scale_x_continuous(
    trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))
  )


saveid <- paste0("script/plot/", substr(system("git rev-parse HEAD", intern = TRUE), 0, 7), "wrap.jpg")
saveid

ggsave(saveid, width = 12, dpi = 900)
```
