 
```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(xtable)
library(gsubfn)
library(fmtr)
library(stringr)
library(common)
library(proto)
library(patchwork)

library(scales)

library(ggthemes)
theme_set(theme_light())
"%!in%" <- function(x, y) !("%in%"(x, y))
# setwd("/home/zmen002/KDtree/")

# options(scipen = 999)
options(digits = 5, nsmall = 3)
```
header[] = solver,benchType,nodes,dims,file,buildTime,queryTime,wrapSize

```{R}
# setwd("/home/zmen002/KDtree")
# kd_proto <- read.csv("script/backup_data/my_kd_proto.csv", header = TRUE)
kd <- read.csv("script/data/test.csv", header = TRUE)
cgal <- read.csv("script/data/cgal.csv", header = TRUE)
zd<-read.csv("script/data/zdtree.csv", header=TRUE)
t <-  bind_rows(zd,kd,cgal)
# View(t)

kd1core <- read.csv("script/data/test_one_core.csv", header = TRUE)
zd1core <- read.csv("script/data/zdtree_one_core.csv", header = TRUE)
t1core <- bind_rows(kd1core,zd1core)

t <- bind_rows(t,t1core)

# View(t1core)
```

define functions 
```{R}
computeAve <- function(t, name){
build <- t %>%
  group_by(solver, benchType, nodes) %>%
  summarise(avg = mean(buildTime), .groups = "drop") %>%
  filter(benchType == name) %>%
  select(solver, benchType, nodes, avg)

query <- t %>%
  group_by(solver, benchType, nodes) %>%
  summarise(avg = mean(queryTime / nodes), .groups = "drop") %>%
  filter(benchType == name) %>%
  select(solver, benchType, nodes, avg)

return (list(build, query))
}
```

plot the graph
```{R}
plot <- function(buildData, queryData, name) {
gBuild <- ggplot(buildData, aes(x = nodes, y = avg, color = solver, shape = solver)) +
  geom_point(size = 3) +
  geom_line() +
  # geom_label(aes(nodes+.1,avg+.1,label=avg,size=4)) +
  theme_gray() +
  labs(y = "Ave build time") +
  ggtitle(name)

gQuery <- ggplot(queryData, aes(x = nodes, y = avg, color = solver, shape = solver)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave query time") + 
  ggtitle(name)

  return (list(gBuild, gQuery))
}
```


```{R}
list[buildVarden, queryVarden] <- computeAve(t,"ss_varden")
list[buildUniform, queryUniform] <- computeAve(t, "uniform")
list[gBuildVarden, gQueryVarden] <- plot(buildVarden,queryVarden, "ss_varden")
list[gBuildUniform, gQueryUniform] <- plot(buildUniform,queryUniform, "uniform")

sortedBuild <- bind_rows(buildVarden,buildUniform) %>% group_by(benchType) %>% arrange(nodes,avg,.by_group=TRUE)
sortedQuery <- bind_rows(queryVarden,queryUniform) %>% group_by(benchType) %>% arrange(nodes,avg,.by_group=TRUE)
sortedQuery$avg<-round(sortedQuery$avg, digits=9)
write.csv(sortedBuild, "script/data/summarize_build.csv")
write.csv(sortedQuery, "script/data/summarize_query.csv")
```

summarize the plot info: https://ggplot2-book.org/arranging-plots.html
c(a,b,c) combine [a,b,c]
seq(2,6,by=2) [2,4,6]

```{R}
saveid <- paste0("script/plot/", substr(system("git rev-parse HEAD", intern = TRUE), 0, 7), ".jpg")
saveid

gBuildVarden + gQueryVarden + gBuildUniform + gQueryUniform
ggsave(saveid, width = 12, dpi = 1800)
```

Now collect the leave wrapping
```{R}
wrap <- read.csv("script/data/single_wrap.csv", header = TRUE)
wrap

wrapQuery <- wrap %>%
  group_by(wrapSize) %>%
  summarise(avg = mean(queryTime / nodes), .groups = "drop") %>%
  select(wrapSize, avg)

wrapBuild <- wrap %>%
  group_by(wrapSize) %>%
  summarise(avg = mean(buildTime / nodes), .groups = "drop") %>%
  select(wrapSize, avg)

# gBuildWrap<-ggplot(wrapBuild, aes(x = wrapSize, y = avg))+
#   geom_point(size=3) +
#   geom_line() +
#   theme_gray() +
#   labs(y="Ave build time")

gQueryWrap <- ggplot(wrapQuery, aes(x = wrapSize, y = avg)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave query time") +
  scale_x_continuous(
    trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))
  )


saveid <- paste0("script/plot/", substr(system("git rev-parse HEAD", intern = TRUE), 0, 7), "wrap.jpg")
saveid

ggsave(saveid, width = 12, dpi = 900)
```
