 
```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(xtable)
library(gsubfn)
library(fmtr)
library(stringr)
library(common)
library(proto)
library(patchwork)

library(scales)

library(ggthemes)
theme_set(theme_light())
"%!in%" <- function(x, y) !("%in%"(x, y))
# setwd("/home/zmen002/KDtree/")

# options(scipen = 999)
# options(digits = 10, nsmall = 3)
```
header[] = solver,benchType,nodes,dims,file,buildTime,queryTime,wrapSize

```{R}
# setwd("/home/zmen002/KDtree")
# kd_proto <- read.csv("script/backup_data/my_kd_proto.csv", header = TRUE)
kd <- read.csv("script/data/my_kd.csv", header = TRUE)
cgal <- read.csv("script/data/cgal.csv", header = TRUE)
t <- cgal %>% bind_rows(kd,cgal)
t
```


```{R}
# queryByDim <- t %>%
#   group_by(solver, benchType, dims) %>%
#   summarise(avg = mean(queryTime / nodes), .groups = "drop") %>%
#   filter(benchType == "craft_var_dim") %>%
#   select(solver, dims, avg)

buildByDim <- t %>%
  group_by(solver, benchType, dims) %>%
  summarise(avg = mean(buildTime), .groups = "drop") %>%
  filter(benchType == "craft_var_dim") %>%
  select(solver, dims, avg)

# queryByNodes <- t %>%
#   group_by(solver, benchType, nodes) %>%
#   summarise(avg = mean(queryTime / nodes), .groups = "drop") %>%
#   filter(benchType == "craft_var_node") %>%
#   select(solver, nodes, avg)

buildByNodes <- t %>%
  group_by(solver, benchType, nodes) %>%
  summarise(avg = mean(buildTime), .groups = "drop") %>%
  filter(benchType == "craft_var_node") %>%
  select(solver, nodes, avg)
```

plot the graph
```{R}
gBuildDim <- ggplot(buildByDim, aes(x = dims, y = avg, color = solver, shape = solver)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave build time") +
  ggtitle("vary dimension") + 
  scale_x_continuous(name = "dims", breaks = seq(2, 26, by = 4), limits = c(2, 26))

# gQueryDim <- ggplot(queryByDim, aes(x = dims, y = avg, color = solver, shape = solver)) +
#   geom_point(size = 3) +
#   geom_line() +
#   theme_gray() +
#   labs(y = "Ave query time") +
#   scale_x_continuous(name = "dims", breaks = seq(2, 26, by = 4), limits = c(2, 26))

gBuildNode <- ggplot(buildByNodes, aes(x = nodes, y = avg, color = solver, shape = solver)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave build time")+
  ggtitle("vary node")

# gQueryNode <- ggplot(queryByNodes, aes(x = nodes, y = avg, color = solver, shape = solver)) +
#   geom_point(size = 3) +
#   geom_line() +
#   theme_gray() +
#   labs(y = "Ave query time")
```

summarize the plot info: https://ggplot2-book.org/arranging-plots.html
c(a,b,c) combine [a,b,c]
seq(2,6,by=2) [2,4,6]

```{R}
saveid <- paste0("script/plot/", substr(system("git rev-parse HEAD", intern = TRUE), 0, 7), ".jpg")
saveid

gBuildDim + gBuildNode
# gBuildDim + gQueryDim + gBuildNode + gQueryNode
ggsave(saveid, width = 12, dpi = 1800)
```

Now collect the leave wrapping
```{R}
wrap <- read.csv("script/data/single_wrap.csv", header = TRUE)
wrap

wrapQuery <- wrap %>%
  group_by(wrapSize) %>%
  summarise(avg = mean(queryTime / nodes), .groups = "drop") %>%
  select(wrapSize, avg)

wrapBuild <- wrap %>%
  group_by(wrapSize) %>%
  summarise(avg = mean(buildTime / nodes), .groups = "drop") %>%
  select(wrapSize, avg)

# gBuildWrap<-ggplot(wrapBuild, aes(x = wrapSize, y = avg))+
#   geom_point(size=3) +
#   geom_line() +
#   theme_gray() +
#   labs(y="Ave build time")

gQueryWrap <- ggplot(wrapQuery, aes(x = wrapSize, y = avg)) +
  geom_point(size = 3) +
  geom_line() +
  theme_gray() +
  labs(y = "Ave query time") +
  scale_x_continuous(
    trans = log2_trans(),
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))
  )


saveid <- paste0("script/plot/", substr(system("git rev-parse HEAD", intern = TRUE), 0, 7), "wrap.jpg")
saveid

ggsave(saveid, width = 12, dpi = 900)
```
